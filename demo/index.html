<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript">
  var SURF_N_PERF = {
    marks: {},
    highResMarks: {}
  };

  SURF_N_PERF.marks.pageStart = (new Date()).getTime();

  if(window.performance) {
    if(window.performance.now) {
      SURF_N_PERF.highResMarks.pageStart = window.performance.now();
    }
    if(window.performance.mark) {
      window.performance.mark('pageStart');
    }
  }

  SURF_N_PERF.visibility = {
    initialState: document.visibilityState,
    stateUpdates: [],
    hiddenProperty: null,
    stateProperty: null,
    eventName: null,
    markChange: function() {
      var markName = 'visibility' + SURF_N_PERF.visibility.stateUpdates.length;

      if (window.performance) {
        if (window.performance.mark) {
          window.performance.mark(markName);
        }

        if (window.performance.now) {
          SURF_N_PERF.highResMarks[markName] = window.performance.now();
        }
      }

      SURF_N_PERF.marks[markName] = new Date().getTime();

      SURF_N_PERF.visibility.stateUpdates.push(document[SURF_N_PERF.visibility.stateProperty]);
    },
  };

  if('hidden' in document) {
    SURF_N_PERF.visibility.hiddenProperty = 'hidden';
    SURF_N_PERF.visibility.stateProperty = 'visibilityState';
    SURF_N_PERF.visibility.eventName = 'visibilitychange';
  } else if('webkitHidden' in document) {
    SURF_N_PERF.visibility.hiddenProperty = 'webkitHidden';
    SURF_N_PERF.visibility.stateProperty = 'webkitVisibilityState';
    SURF_N_PERF.visibility.eventName = 'webkitvisibilitychange';
    SURF_N_PERF.visibility.initialState = document[SURF_N_PERF.visibility.stateProperty];
  }

  SURF_N_PERF.setPageLoad = function() {
    SURF_N_PERF.marks.loadEventEnd = (new Date()).getTime();

    if(window.performance && window.performance.now) {
      SURF_N_PERF.highResMarks.loadEventEnd = window.performance.now();
    }
  };

  SURF_N_PERF.setFirstPaint = function() {
    SURF_N_PERF.marks.firstPaintFrame = (new Date()).getTime();

    if(window.performance && window.performance.now) {
      SURF_N_PERF.highResMarks.firstPaintFrame = window.performance.now();

      if(window.performance.mark) {
        window.performance.mark('firstPaintFrame');
      }
    }
  };

  if(window.addEventListener) {
    if (SURF_N_PERF.visibility.stateProperty) {
      document.addEventListener(SURF_N_PERF.visibility.eventName, SURF_N_PERF.visibility.markChange, false);
    }
    window.addEventListener('load', SURF_N_PERF.setPageLoad, false);
  } else {
    window.attachEvent('onload', SURF_N_PERF.setPageLoad);
  }
  if (window.requestAnimationFrame) {
    window.requestAnimationFrame(SURF_N_PERF.setFirstPaint);
  }
  </script>

  <!-- Bootstrap -->
  <link href="bootstrap.min.css" rel="stylesheet">
  <script src="http://rawgit.com/Comcast/Surf-N-Perf/master/surfnperf.min.js"></script>
  <script src="http://rawgit.com/Comcast/Surf-N-Perf/master/resource-timing.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script type="text/javascript">
    $(window).load(function() {
	  	setTimeout(function() {
	  		surfnperf.eventStart('demo');
	  		surfnperf.setCustom('customKey', 'custom value');
        document.getElementById('networkTime').innerHTML = surfnperf.getNetworkTime();
        document.getElementById('serverTime').innerHTML = surfnperf.getServerTime();
        document.getElementById('networkLatency').innerHTML = surfnperf.getNetworkLatency();
        document.getElementById('processingLoadTime').innerHTML = surfnperf.getProcessingLoadTime();
        document.getElementById('fullRequestLoadTime').innerHTML = surfnperf.getFullRequestLoadTime();
        document.getElementById('getCustom').innerHTML = surfnperf.getCustom('customKey');
        surfnperf.mark('foo');
        document.getElementById('durationStart').innerHTML = surfnperf.duration('pageStart', 'foo');
        document.getElementById('durationEnd').innerHTML = surfnperf.duration('responseEnd','foo');
        document.getElementById('loadEventDuration').innerHTML = surfnperf.duration('loadEventEnd','foo');
        surfnperf.eventEnd('demo');
        document.getElementById('eventDuration').innerHTML = surfnperf.eventDuration('demo');
        document.getElementById('eventDurationDec').innerHTML = surfnperf.eventDuration('demo',{decimalPlaces:10});

        if(window.requestAnimationFrame) {
          window.requestAnimationFrame(function() {
            setTimeout(function() {
              document.getElementById('firstPaint').innerHTML = surfnperf.getFirstPaint() || 'null';
              document.getElementById('firstPaintFrame').innerHTML = surfnperf.getFirstPaintFrame();
            }, 10);
          });
        }

        document.getElementById('isHidden').innerHTML = surfnperf.isHidden();
        document.getElementById('getHiddenTime').innerHTML = surfnperf.getHiddenTime();

        var resource = surfnperfRT.getResources().find(function(r) {
          return r.name.indexOf('jquery.min.js') != -1;
        });

        var collection = document.getElementsByClassName('RTrn');
        for (var i = 0; i < collection.length; i++) {
          collection[i].innerHTML = resource.name;
        }

        document.getElementById('getOrigins').innerHTML = surfnperfRT.getOrigins();
        document.getElementById('getResourcesFromOrigin').innerHTML = surfnperfRT.getResourcesFromOrigin("http://rawgit.com");
        document.getElementById('getResource').innerHTML = JSON.stringify(surfnperfRT.getResource(resource.name)).replace(/,/g,",<br>").replace(/\{/g,"{<br>").replace(/\}/g,"<br>}");
        document.getElementById('duration').innerHTML = surfnperfRT.duration(resource.name, 'connectEnd', 'requestStart');
        document.getElementById('start').innerHTML = surfnperfRT.getStart(resource.name);
        document.getElementById('end').innerHTML = surfnperfRT.getEnd(resource.name);
        document.getElementById('getFullRequestLoadTime').innerHTML = surfnperfRT.getFullRequestLoadTime(resource.name);
        document.getElementById('getNetworkTime').innerHTML = surfnperfRT.getNetworkTime(resource.name);
        document.getElementById('getServerTime').innerHTML = surfnperfRT.getServerTime(resource.name);
        document.getElementById('getBlockingTime').innerHTML = surfnperfRT.getBlockingTime(resource.name);
		}, 0);
	});
  </script>
</head>
<body>
  <h1>Surf-N-Perf</h1>

  <div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading">Surf-N-Perf Demo</div>

  <!-- Table -->
  <table class="table table-bordered" cellspacing="0" width="80%">
    <thead>
      <tr>
        <th> Method </th>
        <th> Status/Loading Time </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td> surfnperf.eventStart('demo') </td>
        <td> <div>Event Started</div></td>
      </tr>
      <tr>
        <td> surfnperf.setCustom('customKey', 'custom value') </td>
        <td> <div>Custom Set</div></td>
      </tr>
      <tr>
        <td> surfnperf.getNetworkTime() </td>
        <td id="networkTime"></td>
      </tr>
      <tr>
        <td> surfnperf.getServerTime() </td>
        <td id="serverTime"></td>
      </tr>
      <tr>
        <td> surfnperf.getNetworkLatency() </td>
        <td id="networkLatency"></td>
      </tr>
      <tr>
        <td> surfnperf.getProcessingLoadTime() </td>
        <td id="processingLoadTime"></td>
      </tr>
      <tr>
        <td> surfnperf.getFullRequestLoadTime() </td>
        <td id="fullRequestLoadTime"></td>
      </tr>
      <tr>
        <td> surfnperf.getFirstPaint() </td>
        <td id="firstPaint"></td>
      </tr>
      <tr>
        <td> surfnperf.getFirstPaintFrame() </td>
        <td id="firstPaintFrame"></td>
      </tr>
      <tr>
        <td> surfnperf.getCustom('customKey') </td>
        <td id="getCustom"></td>
      </tr>
      <tr>
        <td> surfnperf.mark('foo') </td>
        <td> <div>Time Marked</div></td>
      </tr>
      <tr>
        <td> surfnperf.duration('pageStart', 'foo') </td>
        <td id="durationStart"></td>
      </tr>
      <tr>
        <td> surfnperf.duration('responseEnd','foo') </td>
        <td id="durationEnd"></td>
      </tr>
      <tr>
        <td> surfnperf.duration('loadEventEnd','foo') </td>
        <td id="loadEventDuration"></td>
      </tr>
      <tr>
        <td> surfnperf.eventEnd('demo') </td>
        <td> <div> Event Ended </div></td>
      </tr>
      <tr>
        <td> surfnperf.eventDuration('demo') </td>
        <td id="eventDuration"></td>
      </tr>
      <tr>
        <td> surfnperf.eventDuration('demo',{decimalPlaces:10}) </td>
        <td id="eventDurationDec"></td>
      </tr>
      <tr>
        <td> surfnperf.isHidden() </td>
        <td id="isHidden"></td>
      </tr>
      <tr>
        <td> surfnperf.getHiddenTime() </td>
        <td id="getHiddenTime"></td>
      </tr>
    </tbody>
  </table>

  <div class="panel-heading">Resource Timings Demo</div>


  <table class="table table-bordered" cellspacing="0" width="80%">
    <thead>
      <tr>
        <th> Method </th>
        <th> Status/Loading Time </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td> surfnperfRT.getOrigins() </td>
        <td id="getOrigins"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getResourcesFromOrigin("http://rawgit.com") </td>
        <td id="getResourcesFromOrigin"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getResource("<span class="RTrn"></span>") </td>
        <td id="getResource"></td>
      </tr>
      <tr>
        <td> surfnperfRT.duration("<span class="RTrn"></span>", "connectEnd", "requestStart") </td>
        <td id="duration"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getStart("<span class="RTrn"></span>") </td>
        <td id="start"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getEnd("<span class="RTrn"></span>") </td>
        <td id="end"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getFullRequestLoadTime("<span class="RTrn"></span>") </td>
        <td id="getFullRequestLoadTime"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getNetworkTime("<span class="RTrn"></span>") </td>
        <td id="getNetworkTime"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getServerTime("<span class="RTrn"></span>") </td>
        <td id="getServerTime"></td>
      </tr>
      <tr>
        <td> surfnperfRT.getBlockingTime("<span class="RTrn"></span>") </td>
        <td id="getBlockingTime"></td>
      </tr>
    </tbody>
  </table>
</div>
</body>
</html>
