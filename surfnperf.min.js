/*!
 * Copyright 2014 Comcast Cable Communications Management, LLC
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(a,b){"function"==typeof define&&define.amd?define("surfnperf",["underscore"],b):a.surfnperf=b(a._)}(this,function(a){Date.now||(Date.now=function(){return(new Date).getTime()});var b=function(){this._data={custom:{},marks:{},highResMarks:{},events:{}},this._navigationTiming=null,this._highResTime=null,this._userTiming=null,this._navigationTimingEvents={a:["navigationStart","unloadEventEnd","unloadEventStart","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","secureConnectionStart","connectEnd","requestStart","responseStart","responseEnd","domLoading"],b:["domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"]},this.initialize()};return a.extend(b.prototype,{_setPerformanceApis:function(){window.performance?(this._navigationTiming=!!window.performance.timing,this._highResTime=!!window.performance.now,this._userTiming=!!(window.performance.mark&&window.performance.measure&&window.performance.getEntriesByName)):(this._navigationTiming=!1,this._highResTime=!1,this._userTiming=!1)},_setPerfProperties:function(){(a.isUndefined(window.SURF_N_PERF)||!window.SURF_N_PERF.marks)&&(window.SURF_N_PERF={marks:{},highResMarks:{}})},_setInitialUrl:function(){this.setCustom("initialUrl",window.location.pathname)},initialize:function(){this._setPerformanceApis(),this._setPerfProperties(),this._setInitialUrl()},now:function(a){return a=a||"highRes",this._highResTime&&"highRes"===a?window.performance.now():Date.now()},performanceTiming:function(){return this._navigationTiming?window.performance.timing:{}},_performanceTimingL2:function(a){var b=this.getTimingMark("loadEventEnd","DOM")-this.getTimingMark(a,"DOM"),c=window.SURF_N_PERF.highResMarks.loadEventEnd-b;return 0>c?0:this._round(c,{decimalPlaces:10})},getTimingMark:function(b,c){return c=c||"DOM",this._navigationTiming?"DOM"===c||this._highResTime===!1?this.performanceTiming()[b]:this._performanceTimingL2(b):a.contains(this._navigationTimingEvents.a,b)?this.getMark("pageStart","DOM"):this.getMark("loadEventEnd","DOM")},userTiming:function(){return this._userTiming?window.performance:{}},mark:function(a){this._highResTime&&(this._data.highResMarks[a]=this.now()),this._userTiming&&this.userTiming().mark(a),this._data.marks[a]=this.now("DOM")},getMark:function(a,b){var c;return b=b||"highRes","highRes"===b&&this._highResTime===!0&&(c=this._data.highResMarks[a]||window.SURF_N_PERF.highResMarks[a]),c||this._data.marks[a]||window.SURF_N_PERF.marks[a]},_isTimingMark:function(b){return a.contains(this._navigationTimingEvents.a,b)||a.contains(this._navigationTimingEvents.b,b)},_getDurationMark:function(a){return this._isTimingMark(a)?this.getTimingMark(a,"highRes"):this.getMark(a)},_round:function(a,b){b=b||{};var c=b.decimalPlaces||0;return+a.toFixed(c)},_roundedDuration:function(a,b,c){return this._round(b-a,c)},_measureName:function(a,b){return"_SNP_"+a+"_TO_"+b},_setMeasure:function(a,b){this.userTiming().measure(this._measureName(a,b),a,b)},_getMeasureDuration:function(a,b){var c=this.userTiming().getEntriesByName(this._measureName(a,b))[0]||{};return c.duration},duration:function(a,b,c){return this._userTiming?(this._setMeasure(a,b),this._round(this._getMeasureDuration(a,b),c)):this._roundedDuration(this._getDurationMark(a),this._getDurationMark(b),c)},updateEvent:function(b,c,d){var e={};e[b]={},a.defaults(this._data.events,e),this._data.events[b][c]=d},resetEvent:function(a,b,c){this._data.events[a]={},this._data.events[a][b]=c},eventStart:function(a){this.resetEvent(a,"start",this.now())},eventEnd:function(b,c){var d=this.now();c=c||{},a.each(c,function(a,c){this.updateEvent(b,c,a)},this),this.updateEvent(b,"end",d)},getEventData:function(a,b){var c=this._data.events[a];return c?c[b]:void 0},eventDuration:function(a,b){return this._roundedDuration(this.getEventData(a,"start"),this.getEventData(a,"end"),b)},setCustom:function(a,b){this._data.custom[a]=b},getCustom:function(a){return this._data.custom[a]},getNetworkTime:function(){return this.duration("fetchStart","connectEnd")},getServerTime:function(){return this.duration("requestStart","responseEnd")},getNetworkLatency:function(){return this.duration("fetchStart","responseEnd")},getProcessingLoadTime:function(){return this.duration("responseEnd","loadEventEnd")},getFullRequestLoadTime:function(){return this.duration("navigationStart","loadEventEnd")}}),new b});